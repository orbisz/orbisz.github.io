import{_ as e,c,a as l,b as s,d as p,e as t,r as o,o as i}from"./app-ByLG9LQz.js";const u="/assets/img-DJEfqe5L.png",k="/assets/img_1-DU22L46i.png",r="/assets/img_3-Cwwrr_dg.png",d="/assets/img_2-Bk10BNSg.png",v="/assets/img_4-Cmt_E-5u.png",m="/assets/img_5-D_smlXNU.png",b="/assets/img_7-CAMrLLwt.png",g="/assets/img_6-BmZfA52m.png",y="/assets/img_8-bB8ZWItM.png",w="/assets/img_9-gDiULnMn.png",h={},f={href:"https://juejin.cn/post/7280008213662531599?searchId=20231228182847325B01E439E277406844#heading-6",target:"_blank",rel:"noopener noreferrer"},q={href:"https://mp.weixin.qq.com/s/9seHYBOAfXCsD-WKiR9Bxg",target:"_blank",rel:"noopener noreferrer"};function S(C,n){const a=o("ExternalLinkIcon");return i(),c("div",null,[n[2]||(n[2]=l('<h2 id="业务功能设计" tabindex="-1"><a class="header-anchor" href="#业务功能设计"><span>业务功能设计</span></a></h2><p>本项目的目的是实现一个动态代码评审SDK，动态代码评审需要什么？</p><ul><li>git diff：评审两次提交的差异记录</li><li>openai：通过LLM去分析评审代码变化记录，根据设置好的提示词（prompt），告诉LLM需要注意哪些点，如何评审以及从哪种视角出发去评审，检测是否有风险等等，再把结果返回</li><li>通知：评审结果需要通知，简单的可以通过公众号测试平台，对于企业订阅号可以根据具体的消息模板设置</li></ul><p>大致流程如下： <img src="'+u+'" alt="img.png"></p><p>那么问题就来了，<code>SDK</code>创建好了，由谁来调用这个组件实现这一套流程呢</p><ol><li>直接在业务工程中引入这个SDK包，哪个工程需要自动评审的功能引入该<code>SDK</code>即可，但是每个工程都需要引入，代码侵入性高；</li><li><code>GitHub Actions</code> <code>CI&amp;CD</code>, 将<code>Github Action</code>看成一台云服务器，它可通过拉取镜像系统文件来执行我们的脚本文件，这里的文件就是上面的workflow文件；</li><li>webhook 钩子，提供一个配置接口，去调用服务实现流程，需要云服务器部署服务。</li></ol><p>前两种都存在一定不足，所以作者使用了第三种，那么SDK是如何与<code>Github Action</code>关联的呢，流程如下： <img src="'+k+`" alt="img_1.png"> 需要使用代码自动评审的用户通过<code>CURL</code>下载<code>SDK</code>到本地，以<code>jar</code>包的方式执行调用<code>SDK</code>的<code>Main</code>函数。</p><blockquote><p>关于什么是CURL?，C表示的是客户端client，其是一款开源的命令行工具与库，几乎覆盖所有常见的网络协议（HTTP、HTTPS、FTP等等），起作用如下：</p><ul><li>1）API接口测试，可以通过命令行发送GET/POST/DELETE/PUT请求；</li><li>2）下载或上传文件，这里我们使用的就是该功能；</li><li>3）提交表单数据；</li><li>4）自动化脚本；</li><li>5）检测网络问题；</li></ul></blockquote><p>检出提交记录：连接git，检出当前所有的分支或所有代码的变更记录.</p><p>评审记录:把评审记录写道自建的log日志仓库中，并把url地址返回给通知.</p><p>整个功能流程实现中最关键的在于prompt的设计和llm的调用</p><p><span style="color:#ff6600;"><strong>功能扩展：</strong></span> 自己写一个issue需求说明，让llm来完成功能实现，并创建分支，进行编码写好mock测试，与需求说明对比提交，再合并代码。</p><h2 id="项目背景知识" tabindex="-1"><a class="header-anchor" href="#项目背景知识"><span>项目背景知识</span></a></h2><h3 id="_1、ci-cd" tabindex="-1"><a class="header-anchor" href="#_1、ci-cd"><span>1、CI&amp;CD</span></a></h3><p><code>CI&amp;CD</code>是持续集成(<code>Continuous Integration</code>)、持续交付(<code>Continuous Delivery</code>)的简称，旨在通过自动化的流程与工具，提高软件开发的效率、质量和交付速度。</p><h4 id="_1-1-ci" tabindex="-1"><a class="header-anchor" href="#_1-1-ci"><span>1.1 CI</span></a></h4><p><code>CI</code>意为持续集成，其操作就是频繁的将代码提交到主干；持续集成的目的是为了快速迭代，同时保证代码的质量；使用git多方协作，提交代码分支以及分支合并的过程就是持续集成的思想所在。</p><p>持续集成的过程为：在协同开发中，每个人都有自己负责的模块，也有可能一个人负责多个模块。所有的代码由版本控制工具集成在共享存储库中，开发人员由自己的需求创建分支，开发完成后需要提交分支代码并且将代码合并到主分支，这时就需要解决代码冲突的问题，可以通过<code>code review</code>即代码评审的方式，一旦提交请求合并到主分支。自动化构建共聚就会根据流程自动编译构建安装应用，并执行单元测试框架的自动化测试来校验提交的修改。</p><p><code>CI</code>中使用的关键组件有：</p><ol><li>版本控制系统，如·<code>Git</code>；</li><li>自动化构建工具，如<code>jenkins</code>，每次提交代码之后自动构建的过程；</li><li>单元测试框架，如<code>junit</code>框架，目的是为了确保基础功能在集成之后仍然有效；</li></ol><h4 id="_1-2-cd" tabindex="-1"><a class="header-anchor" href="#_1-2-cd"><span>1.2 CD</span></a></h4><p><code>CD</code>意为持续交付，可以看作持续集成的下一阶段，其操作是不断将软件的新版本，交给软件项目质量检查团，以供评审；持续交付的目的是无论软件迭代多少个版本，都可以随时交付；</p><p>此时持续交付的代码已经在主分支上了，随时可以通过自动部署工具部署在服务器上。并且监控不同环境（开发、测试、生产）的项目状态。</p><p><code>CD</code>中使用的关键组件有：</p><ol><li>自动部署工具，如常用的<code>Docker</code>、<code>Docker-Compose</code>、<code>K8s</code>等等；</li><li>环境配置工具，如<code>Terraform</code>，确保不同环境（开发、测试、生产）的一致性；</li><li>持续监控及反馈，目的是在项目部署之后监控项目的状态，如普罗米修斯（<code>Prometheus</code>）、<code>Grafana</code>；</li></ol><p>与之相关的还有持续部署（<code>Continuous Deployment</code>）的概念，就是在通过评审之后，项目完成自动化的部署，持续部署可以看作持续交付的下一个阶段；持续部署的目的是，项目在任何时刻都是可以部署的，可以立刻投入生产阶段；</p><h3 id="_2、github-action" tabindex="-1"><a class="header-anchor" href="#_2、github-action"><span>2、Github Action</span></a></h3><p>采用<code>CI/CD</code>可以通过自动化流程和工具帮你构建应用、测试应用、部署应用，将你的应用交给流程工具来管理，实现自动触发、验证、部署等等，从而减少人力成本，提高交付质量与效率；这在敏捷开发与<code>DevOps</code>中扮演者重要的角色；</p><p><code>Github Action</code>就是<code>Github</code>开发的一款实现持续集成交付的自动化流程工具组件，用户可以通过<code>yaml</code>配置文件来构建执行<code>CI/CD</code>流水线，并可以在触发不同事件（如代码的提交、推送、合并）时执行这些自动流程；而这种事件触发机制就是代码仓库的<code>Hook</code>;可以将<code>github action</code>看成一台免费的服务器，可以在上面执行自动化流程命令；</p><p>官方文档：https://docs.github.com/zh/actions/get-started/quickstart</p><p>Github Action中的几个核心概念为：</p><ol><li>WorkFlow(工作流)：workflow是Github Action任务执行的基本单位，</li><li>job(任务)：一个workflow由一个或多个jobs构成，含义是一次持续集成的运行；</li><li>step(步骤)：一个job由多个step组成，一步步完成；</li><li>action(动作)：每个step可以依次执行一个或多个命令；</li></ol><h4 id="_2-1-工作流文件编写" tabindex="-1"><a class="header-anchor" href="#_2-1-工作流文件编写"><span>2.1 工作流文件编写</span></a></h4><p>工作流文件是yaml格式，文件的大致内容可能为：</p><ol><li>指定工作流名称，在Action的任务中以该名展示；</li><li>on来指定工作流触发条件（Hook钩子触发机制），例如在代码push到master分支时执行；</li><li>job编写工作流程，是工作流文件的核心，一个工作流文件可以执行多个job，一个job下有至少一个step;</li></ol><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token comment"># 1、工作流名称</span></span>
<span class="line"><span class="token key atrule">name</span><span class="token punctuation">:</span></span>
<span class="line"><span class="token comment"># 2、工作流触发条件</span></span>
<span class="line"><span class="token key atrule">on</span><span class="token punctuation">:</span></span>
<span class="line"><span class="token comment"># 3、具体工作任务</span></span>
<span class="line"><span class="token key atrule">job1</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">step1</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">step2</span><span class="token punctuation">:</span></span>
<span class="line"><span class="token key atrule">job2</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">step1</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">step2</span><span class="token punctuation">:</span>    </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>注意：工作流文件需要放在指定目录下，才能被github识别然后自动执行，目录结构为：/.github/workflows/</p></blockquote><h2 id="sdk工程搭建" tabindex="-1"><a class="header-anchor" href="#sdk工程搭建"><span>SDK工程搭建</span></a></h2><p>项目的基本结构如下： <img src="`+r+`" alt="img_3.png"> 项目包含创建两个模块</p><ul><li><code>SDK</code>：功能实现模块，github action调用该模块实现code review</li><li><code>test</code>：项目中的功能测试模块，引入 SDK 与常用依赖，提供最小化的入口与测试骨架，方便在不影响主模块的情况下验证 SDK 或框架配置。</li></ul><p><strong>注意</strong>：<code>SDK</code>模块最终会被打包成jar包，该模块所需要的<code>Maven</code>以来也需要同时打包，为了保证环境的一致性，避免使用时还需要去重新加载依赖项目，这里需要配置需要打包的依赖如下</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line"><span class="token comment">&lt;!-- 如果你用了三方jar，不想一个个确定的引入，可以去掉 configuration 以及以内的配置，这样会全部打包 --&gt;</span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactSet</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>includes</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>include</span><span class="token punctuation">&gt;</span></span>com.google.guava:guava:jar:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>include</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>include</span><span class="token punctuation">&gt;</span></span>com.alibaba.fastjson2:fastjson2:jar:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>include</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>include</span><span class="token punctuation">&gt;</span></span>org.slf4j:slf4j-api:jar:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>include</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>include</span><span class="token punctuation">&gt;</span></span>org.slf4j:slf4j-simple:jar:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>include</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>include</span><span class="token punctuation">&gt;</span></span>com.auth0:java-jwt:jar:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>include</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>include</span><span class="token punctuation">&gt;</span></span>com.fasterxml.jackson.core:jackson-core:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>include</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>include</span><span class="token punctuation">&gt;</span></span>com.fasterxml.jackson.core:jackson-databind:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>include</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>include</span><span class="token punctuation">&gt;</span></span>com.fasterxml.jackson.core:jackson-annotations:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>include</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>include</span><span class="token punctuation">&gt;</span></span>org.eclipse.jgit:org.eclipse.jgit:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>include</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>includes</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactSet</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="maven构建与脚本执行" tabindex="-1"><a class="header-anchor" href="#maven构建与脚本执行"><span>Maven构建与脚本执行</span></a></h2><p>为了测试模拟其他工程使用该SDK的场景，需要创建一个新的工作流文件（workflow），执行流程如下 <img src="`+d+`" alt="img_2.png"></p><p>对应的<code>workflow</code>文件为：</p><div class="language-YAML line-numbers-mode" data-highlighter="prismjs" data-ext="YAML" data-title="YAML"><pre><code><span class="line"># 1、工作流文件名称</span>
<span class="line">name: Build and Run Openai-Code-Review By Main Maven Jar</span>
<span class="line"></span>
<span class="line"># 2、触发规则</span>
<span class="line">on:</span>
<span class="line">  push:</span>
<span class="line">    branches:</span>
<span class="line">      - &#39;*&#39;</span>
<span class="line">  pull_request:</span>
<span class="line">    branches:</span>
<span class="line">      - &#39;*&#39;</span>
<span class="line"></span>
<span class="line"># 3、构建任务, 其中检出代码与配置JDK环境是通用的</span>
<span class="line">jobs:</span>
<span class="line">  build:</span>
<span class="line">    runs-on: ubuntu-latest # 使用ubuntu最新版本虚拟机</span>
<span class="line"></span>
<span class="line">    steps:</span>
<span class="line">      - name: Checkout repository  # 检出代码</span>
<span class="line">        uses: actions/checkout@v3</span>
<span class="line">        with:</span>
<span class="line">          fetch-depth: 2</span>
<span class="line"></span>
<span class="line">      - name: Setup JDK 17   # 配置JDK环境</span>
<span class="line">        uses: actions/setup-java@v3</span>
<span class="line">        with:</span>
<span class="line">          distribution: &#39;adopt&#39;</span>
<span class="line">          java-version: &#39;17&#39;</span>
<span class="line"></span>
<span class="line">      - name: Build with Maven  # 编译构建Maven</span>
<span class="line">        run: mvn clean install</span>
<span class="line"></span>
<span class="line">      - name: Copy Openai-Code-Review-SDK JAR  # 复制JAR包</span>
<span class="line">        run: mvn dependency:copy -Dartifact=com.lz:openai-code-review-sdk:1.0 -DoutputDirectory=./libs</span>
<span class="line"></span>
<span class="line">      - name: Run Code Review  # 运行SDK的jar包</span>
<span class="line">        run: java -jar ./libs/openai-code-review-sdk-1.0.jar</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>steps</code>中的五个步骤就对应上图中的五个流程。</p><blockquote><p>一个 .yml 文件对应一个 workflow，也就是一次持续集成。一个 GitHub 仓库可以包含多个 workflow，只要是在 .github/workflow 目录下的 .yml 文件都会被 GitHub 执行。</p></blockquote><p><span style="color:#ff6600;"><strong>扩展：</strong></span>可以参考市场中共享的actions去包装完善、创新自己的action，并且可以将我们的共享actions给其他人使用。</p><p>具体检出<code>diff</code>的代码为：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OpenAiCodeReview</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;开始CI/CD&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// 1.检出代码diff,</span></span>
<span class="line">        <span class="token class-name">ProcessBuilder</span> processBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProcessBuilder</span><span class="token punctuation">(</span><span class="token string">&quot;git&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;diff&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;HEAD~1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;HEAD&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        processBuilder<span class="token punctuation">.</span><span class="token function">directory</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">Process</span> process <span class="token operator">=</span> processBuilder<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">        <span class="token class-name">BufferedReader</span> reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">String</span> line<span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">StringBuilder</span> diffCode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>line <span class="token operator">=</span> reader<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            diffCode<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token char">&#39;\\n&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">int</span> exitCode <span class="token operator">=</span> process<span class="token punctuation">.</span><span class="token function">waitFor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Exited with code:&quot;</span> <span class="token operator">+</span> exitCode<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;评审代码: &quot;</span> <span class="token operator">+</span> diffCode<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p><code>PricessBuilder</code>是Java中用来创建与管理操作系统的类，它允许你在Java程序中启动外部程序（如命令行、脚本或者其他可执行文件），并与其进行交互（例如传递输入、捕获输出或错误流）。相比传统的<code>Runtime.exec()</code>，<code>ProcessBuilder</code>提供了更灵活且安全的进程控制方式；</p></blockquote><p>提交代码到github上，就可以观察到<code>github Action</code>的执行流程,获取到最近两次提交变更代码的字符串。AI代码评审的本质就是将这种字符串传递给AI大模型，让大模型替我们进行整理、归纳、总结。 <img src="`+v+`" alt="img_4.png"></p><h2 id="大模型对接-chatglm" tabindex="-1"><a class="header-anchor" href="#大模型对接-chatglm"><span>大模型对接-ChatGlm</span></a></h2><h3 id="流程分析" tabindex="-1"><a class="header-anchor" href="#流程分析"><span>流程分析</span></a></h3><p>本节主要任务是对接<code>ChatGlm</code>大模型，代码评审的本质就是将用户提供的<code>code diff</code>交给大模型做理解分析，最后返回评审结果;</p><p>智谱官方文档：https://www.bigmodel.cn/dev/api/normal-model/glm-4</p><p>对接时，作者并没有直接引入<code>SDK</code>包，而是通过Java原生API与原生网络请求来搭建了一个简单的组件项目，不使用如Lombok、OkHttp等外部组件，如果引入过多的依赖与SDK，会使得本来轻量的组件显得臃肿，不符合我们开发的初衷；</p><p>等开发完成<code>OpenAiSDK</code>组件后，再引入<code>SDK</code>对接，直接一步到位对接其他的大模型。</p><p>关于接口对接鉴权，智谱提供了两种鉴权方式：</p><ul><li>ApiKey鉴权</li><li>Token鉴权</li></ul><p>出于安全考虑，这里采用了Token鉴权方式，使用JWT签名.</p><blockquote><ol><li>ApiKey鉴权，通过一个静态的字符串来表示请求方的身份，无状态且长期有效，但是安全性低；</li><li>Token鉴权，Token 是一个 动态的凭证（如 JWT、OAuth2 Token），通常在用户登录后由服务端动态生成，包含身份信息、有效期和签名，用于临时授权。安全性高，可进行加密、刷新等操作；</li></ol></blockquote><h3 id="代码实现" tabindex="-1"><a class="header-anchor" href="#代码实现"><span>代码实现</span></a></h3><p>首先创建一个工具类<code>BearerTokenUtils</code>, 通过对<code>ApiKey</code>密钥结构拆分，然后通过<code>JWT</code>签名的方式生成<code>token</code>,</p><div class="language-JAVA line-numbers-mode" data-highlighter="prismjs" data-ext="JAVA" data-title="JAVA"><pre><code><span class="line">public class BearerTokenUtils {</span>
<span class="line"></span>
<span class="line">    // 过期时间：默认30分钟</span>
<span class="line">    private static final long expireMillis = 30*60*1000L;</span>
<span class="line"></span>
<span class="line">    // 缓存服务</span>
<span class="line">    public static Cache&lt;String,String&gt; cache = CacheBuilder.newBuilder()</span>
<span class="line">            .expireAfterWrite(expireMillis - (60*1000L), TimeUnit.MILLISECONDS)</span>
<span class="line">            .build();</span>
<span class="line"></span>
<span class="line">    public static String getToken(String apiKeySecret){</span>
<span class="line">        String[] split = apiKeySecret.split(&quot;\\\\.&quot;);</span>
<span class="line">        return getToken(split[0],split[1]);</span>
<span class="line">    }</span>
<span class="line"></span>
<span class="line">    public static String getToken(String apiKey,String apiSecret){</span>
<span class="line">        //缓存Token</span>
<span class="line">        String token = cache.getIfPresent(apiKey);</span>
<span class="line">        if(null!=token) return token;</span>
<span class="line">        //创建Token</span>
<span class="line">        Algorithm algorithm = Algorithm.HMAC256(apiSecret.getBytes(StandardCharsets.UTF_8));</span>
<span class="line">        Map&lt;String, Object&gt; payload = new HashMap&lt;&gt;();</span>
<span class="line">        payload.put(&quot;api_key&quot;,apiKey);</span>
<span class="line">        payload.put(&quot;exp&quot;,System.currentTimeMillis()+expireMillis);</span>
<span class="line">        payload.put(&quot;timestamp&quot;, Calendar.getInstance().getTimeInMillis());</span>
<span class="line">        Map&lt;String,Object&gt; headerClaims = new HashMap&lt;&gt;();</span>
<span class="line">        headerClaims.put(&quot;alg&quot;,&quot;HS256&quot;);</span>
<span class="line">        headerClaims.put(&quot;sign_type&quot;,&quot;SIGN&quot;);</span>
<span class="line">        token = JWT.create().withPayload(payload).withHeader(headerClaims).sign(algorithm);</span>
<span class="line">        cache.put(apiKey, token);</span>
<span class="line">        return token;</span>
<span class="line">    }</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>接着根据模型对接文档创建模型请求与响应对象，只保留我们需要的关键属性，十分简洁；</p><ul><li><strong>请求对象</strong></li></ul><div class="language-JAVA line-numbers-mode" data-highlighter="prismjs" data-ext="JAVA" data-title="JAVA"><pre><code><span class="line">public class ChatCompletionRequest {</span>
<span class="line">    private String model = Model.GLM_4_5_Air.getCode();</span>
<span class="line">    private List&lt;Prompt&gt; messages;</span>
<span class="line"></span>
<span class="line"></span>
<span class="line">    public static class Prompt{</span>
<span class="line">        private String role;</span>
<span class="line">        private String content;</span>
<span class="line"></span>
<span class="line">        public Prompt(){</span>
<span class="line"></span>
<span class="line">        }</span>
<span class="line">        public Prompt(String role,String content){</span>
<span class="line">            this.role = role;</span>
<span class="line">            this.content = content;</span>
<span class="line">        }</span>
<span class="line"></span>
<span class="line">        ... getter and setter</span>
<span class="line"></span>
<span class="line">    }</span>
<span class="line">    ... getter and setter</span>
<span class="line"></span>
<span class="line">} </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>响应对象</li></ul><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ChatCompletionSyncResponse</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Choice</span><span class="token punctuation">&gt;</span></span> choices<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Choice</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">private</span> <span class="token class-name">Message</span> message<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">public</span> <span class="token class-name">Message</span> <span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> message<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span>message <span class="token operator">=</span> message<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Message</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">private</span> <span class="token class-name">String</span> role<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">private</span> <span class="token class-name">String</span> content<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getRole</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> role<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> content<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setRole</span><span class="token punctuation">(</span><span class="token class-name">String</span> role<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span>role <span class="token operator">=</span> role<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setContent</span><span class="token punctuation">(</span><span class="token class-name">String</span> content<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span>content <span class="token operator">=</span> content<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Choice</span><span class="token punctuation">&gt;</span></span> <span class="token function">getChoices</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> choices<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setChoices</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Choice</span><span class="token punctuation">&gt;</span></span> choices<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>choices <span class="token operator">=</span> choices<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后就是通过Java原生网络Api发送Http请求到<code>ChatGlm</code>，然后通过流读取评审结果；</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">codeReview</span><span class="token punctuation">(</span><span class="token class-name">String</span> diffCode<span class="token punctuation">)</span><span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">String</span> apiKey <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">&quot;GLM_KEY&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//String apiKey = &quot;a96e4f3b1ac040859ab86fdfc7bcdede.QpOgtBdp83eRWQMd&quot;;</span></span>
<span class="line">        <span class="token class-name">String</span> token <span class="token operator">=</span> <span class="token class-name">BearerTokenUtils</span><span class="token punctuation">.</span><span class="token function">getToken</span><span class="token punctuation">(</span>apiKey<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token class-name">URL</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span><span class="token string">&quot;https://open.bigmodel.cn/api/paas/v4/chat/completions&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">HttpURLConnection</span> connection <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HttpURLConnection</span><span class="token punctuation">)</span> url<span class="token punctuation">.</span><span class="token function">openConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        connection<span class="token punctuation">.</span><span class="token function">setRequestMethod</span><span class="token punctuation">(</span><span class="token string">&quot;POST&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        connection<span class="token punctuation">.</span><span class="token function">setRequestProperty</span><span class="token punctuation">(</span><span class="token string">&quot;Authorization&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Bearer &quot;</span> <span class="token operator">+</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        connection<span class="token punctuation">.</span><span class="token function">setRequestProperty</span><span class="token punctuation">(</span><span class="token string">&quot;Content-Type&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;application/json&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        connection<span class="token punctuation">.</span><span class="token function">setRequestProperty</span><span class="token punctuation">(</span><span class="token string">&quot;User-Agent&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;Mozilla/4.0 (compatible; MSIE 5.0; Windows NT; DigExt)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        connection<span class="token punctuation">.</span><span class="token function">setDoOutput</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token class-name">ChatCompletionRequest</span> chatCompletionRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChatCompletionRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        chatCompletionRequest<span class="token punctuation">.</span><span class="token function">setModel</span><span class="token punctuation">(</span><span class="token class-name">Model<span class="token punctuation">.</span>GLM_4_5_Air</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        chatCompletionRequest<span class="token punctuation">.</span><span class="token function">setMessages</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ChatCompletionRequest<span class="token punctuation">.</span>Prompt</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">7988151926241837899L</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">{</span></span>
<span class="line">                <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChatCompletionRequest<span class="token punctuation">.</span>Prompt</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;你是一个高级编程架构师，精通各类场景方案、架构设计和编程语言请，请您根据git diff记录，对代码做出评审。代码如下: &quot;</span> <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChatCompletionRequest<span class="token punctuation">.</span>Prompt</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span>diffCode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">try</span><span class="token punctuation">(</span><span class="token class-name">OutputStream</span> os <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> input <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>chatCompletionRequest<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            os<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">int</span> responseCode <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">getResponseCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Response Code: &quot;</span> <span class="token operator">+</span> responseCode<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token class-name">BufferedReader</span> in <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span>connection<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">String</span> inputLine<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token class-name">StringBuilder</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>inputLine<span class="token operator">=</span>in<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            context<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>inputLine<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        in<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">;</span></span>
<span class="line">        connection<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;评审结果：&quot;</span><span class="token operator">+</span>context<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token class-name">ChatCompletionSyncResponse</span> response <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ChatCompletionSyncResponse</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> response<span class="token punctuation">.</span><span class="token function">getChoices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>代码中使用<code>System.getenv()</code>从环境变量中获取密钥信息，相较之硬编码到程序里更安全一些。 当通过Github的<code>workflow</code>执行时，密钥的信息可以在Github的<code>Environment secret</code>中维护（工程仓库 Settings → Secrets and variables → Actions），需要更改下<code>workflow</code>脚本</p><div class="language-yawl line-numbers-mode" data-highlighter="prismjs" data-ext="yawl" data-title="yawl"><pre><code><span class="line">jobs:</span>
<span class="line">  build:</span>
<span class="line">    runs-on: ubuntu-latest</span>
<span class="line">    environment: GLM_KEY       # 这里是环境名</span>
<span class="line">    ...</span>
<span class="line">    </span>
<span class="line">    ...</span>
<span class="line">      - name: Run Code Review</span>
<span class="line">        env:</span>
<span class="line">          GLM_KEY: \${{ secrets.GLM_KEY }}</span>
<span class="line"></span>
<span class="line">        run: java -jar ./libs/openai-code-review-sdk-1.0.jar</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>整个流程即为：修改测试模块中的代码，并提交到github，通过<code>ProcessBuilder</code>拿到<code>code diff</code>之后，调用大模型评审，返回并输出评审结果；</p><h2 id="评审日志处理" tabindex="-1"><a class="header-anchor" href="#评审日志处理"><span>评审日志处理</span></a></h2><h3 id="流程分析-1" tabindex="-1"><a class="header-anchor" href="#流程分析-1"><span>流程分析</span></a></h3><p>虽然接入大模型得到了评审结果，但其评审记录只能在<code>Github Action</code>中看到，每一次工作流文件执行都会创建一个新的<code>Runner</code>环境，之前的评审记录就丢失了；</p><p>本节的任务就是保存评审记录，将评审记录保存在<code>Github</code>日志仓库，这就涉及到<code>git</code>的操作，并且需要在Java代码中操作<code>git</code>;需要使用到<code>jgit</code>组件，用于在Java中操作<code>git</code>;</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line">&lt;dependency<span class="token punctuation">&gt;</span></span>
<span class="line">    &lt;groupId<span class="token punctuation">&gt;</span>org.eclipse.jgit&lt;/groupId<span class="token punctuation">&gt;</span></span>
<span class="line">    &lt;artifactId<span class="token punctuation">&gt;</span>org.eclipse.jgit&lt;/artifactId<span class="token punctuation">&gt;</span></span>
<span class="line">    &lt;version<span class="token punctuation">&gt;</span>6.6.1.202309021850<span class="token punctuation">-</span>r&lt;/version<span class="token punctuation">&gt;</span></span>
<span class="line">&lt;/dependency<span class="token punctuation">&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>日志处理流程图如下： <img src="`+m+'" alt="img_5.png"></p><h3 id="代码实现-1" tabindex="-1"><a class="header-anchor" href="#代码实现-1"><span>代码实现</span></a></h3><p>在操作git时需要做身份校验，会使用到<code>github</code>的token，在S<code>ettings</code>里创建 <img src="'+b+'" alt="img_7.png"><img src="'+g+`" alt="img_6.png"></p><p>然后将其配置在<code>Repository secret</code>中，方便SDK通过工作流读取，并将其加入<code>workflow</code>的环境变量中。</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Run Code Review</span>
<span class="line">  <span class="token key atrule">env</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">GLM_KEY</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.GLM_KEY <span class="token punctuation">}</span><span class="token punctuation">}</span></span>
<span class="line">    <span class="token key atrule">GITHUB_TOKEN</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.CODE_TOKEN <span class="token punctuation">}</span><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>那么日志存储的代码为：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line">* 日志文件存储</span>
<span class="line">* <span class="token keyword">@param</span> <span class="token parameter">token</span></span>
<span class="line">* <span class="token keyword">@param</span> <span class="token parameter">log</span></span>
<span class="line">* <span class="token keyword">@return</span></span>
<span class="line">* <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">Exception</span></span></span>
<span class="line">*/</span></span>
<span class="line"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">writeLog</span><span class="token punctuation">(</span><span class="token class-name">String</span> token<span class="token punctuation">,</span> <span class="token class-name">String</span> log<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">Git</span> git <span class="token operator">=</span> <span class="token class-name">Git</span><span class="token punctuation">.</span><span class="token function">cloneRepository</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">setURI</span><span class="token punctuation">(</span><span class="token string">&quot;https://github.com/orbisz/openai-code-review-log.git&quot;</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">setDirectory</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">&quot;repo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">setCredentialsProvider</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UsernamePasswordCredentialsProvider</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token class-name">String</span> dateFolderName <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">&quot;yyyy-MM-dd&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">File</span> dateFolder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">&quot;repo/&quot;</span> <span class="token operator">+</span> dateFolderName<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dateFolder<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        dateFolder<span class="token punctuation">.</span><span class="token function">mkdirs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token class-name">String</span> fileName <span class="token operator">=</span> <span class="token function">generateRandomString</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;.md&quot;</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">File</span> newFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>dateFolder<span class="token punctuation">,</span> fileName<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">try</span><span class="token punctuation">(</span><span class="token class-name">FileWriter</span> writer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileWriter</span><span class="token punctuation">(</span>newFile<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        writer<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>log<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    git<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addFilepattern</span><span class="token punctuation">(</span>dateFolderName<span class="token operator">+</span><span class="token string">&quot;/&quot;</span><span class="token operator">+</span>fileName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    git<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setMessage</span><span class="token punctuation">(</span><span class="token string">&quot;Add new file via GitHub Actions&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    git<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setCredentialsProvider</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UsernamePasswordCredentialsProvider</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Changes have been pushed to the repository.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token string">&quot;https://github.com/orbisz/openai-code-review-log/blob/master/&quot;</span><span class="token operator">+</span>dateFolderName<span class="token operator">+</span><span class="token string">&quot;/&quot;</span><span class="token operator">+</span>fileName<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * 生成指定长度的随机字符串</span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">length</span></span>
<span class="line"> * <span class="token keyword">@return</span></span>
<span class="line"> */</span></span>
<span class="line"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">generateRandomString</span><span class="token punctuation">(</span><span class="token keyword">int</span> length<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">String</span> characters <span class="token operator">=</span> <span class="token string">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789&quot;</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">StringBuilder</span> sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> characters<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>characters<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上述日志文件的命名是一个12位随机字符串，没有区分度，考虑拼接提交者信息、提交仓库、提交分支、提交日期等信息；</p><p><strong>通过执行git相关命令</strong></p><p><code>git log</code>命令的作用是查看提交历史版本，而<code>git branch</code>则是可以操作分支，查询文档后，于是产生以下两条命令：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">git</span> log <span class="token parameter variable">-1</span> <span class="token parameter variable">--pretty</span><span class="token operator">=</span>%cn  <span class="token comment"># 查看分支的提交者</span></span>
<span class="line"><span class="token function">git</span> branch --show-current  <span class="token comment"># 查看当前的分支</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>那么修改后的工作流文件为：</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Get Commit Author  <span class="token comment"># 获取提交人的信息</span></span>
<span class="line">  <span class="token key atrule">run</span><span class="token punctuation">:</span> echo &quot;COMMIT_AUTHOR=$(git log <span class="token punctuation">-</span>1 <span class="token punctuation">-</span><span class="token punctuation">-</span>pretty=%cn)&quot; <span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span> $GITHUB_ENV</span>
<span class="line"></span>
<span class="line"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Get Commit Branch  <span class="token comment"># 获取提交的分支名</span></span>
<span class="line">  <span class="token key atrule">run</span><span class="token punctuation">:</span> echo &quot;COMMIT_BRANCH=$(git branch <span class="token punctuation">-</span><span class="token punctuation">-</span>show<span class="token punctuation">-</span>current)&quot; <span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span> $GITHUB_ENV</span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Copy openai<span class="token punctuation">-</span>code<span class="token punctuation">-</span>review<span class="token punctuation">-</span>sdk JAR</span>
<span class="line">  <span class="token key atrule">run</span><span class="token punctuation">:</span> mvn dependency<span class="token punctuation">:</span>copy <span class="token punctuation">-</span>Dartifact=orbiszx.project<span class="token punctuation">:</span>openai<span class="token punctuation">-</span>code<span class="token punctuation">-</span>review<span class="token punctuation">-</span>sdk<span class="token punctuation">:</span>1.0 <span class="token punctuation">-</span>DoutputDirectory=./libs</span>
<span class="line"></span>
<span class="line"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Run Code Review</span>
<span class="line">  <span class="token key atrule">env</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">GLM_KEY</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.GLM_KEY <span class="token punctuation">}</span><span class="token punctuation">}</span></span>
<span class="line">    <span class="token key atrule">GITHUB_TOKEN</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.CODE_TOKEN <span class="token punctuation">}</span><span class="token punctuation">}</span></span>
<span class="line">    <span class="token key atrule">COMMIT_AUTHOR</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span>env.COMMIT_AUTHOR<span class="token punctuation">}</span><span class="token punctuation">}</span></span>
<span class="line">    <span class="token key atrule">COMMIT_BRANCH</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span>env.COMMIT_BRANCH<span class="token punctuation">}</span><span class="token punctuation">}</span></span>
<span class="line">    <span class="token key atrule">REPOSITORY</span><span class="token punctuation">:</span>    $<span class="token punctuation">{</span><span class="token punctuation">{</span> github.repository <span class="token punctuation">}</span><span class="token punctuation">}</span>  <span class="token comment">#  提交仓库名</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>修改后的业务代码为：这里使用提交者 + 提交仓库名 + 提交分支 + 4位随机字符串的方式命名文件。</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token class-name">String</span> commitAuthor <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">&quot;COMMIT_AUTHOR&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">String</span> commitBranch <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">&quot;COMMIT_BRANCH&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">String</span> repo <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">&quot;REPOSITORY&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">int</span> idx <span class="token operator">=</span> repo<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token char">&#39;/&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">String</span> repository <span class="token operator">=</span> <span class="token punctuation">(</span>idx <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> idx <span class="token operator">&lt;</span> repo<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span></span>
<span class="line">                <span class="token operator">?</span> repo<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>idx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span></span>
<span class="line">                <span class="token operator">:</span> repo<span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">String</span> fileName <span class="token operator">=</span> commitAuthor <span class="token operator">+</span> <span class="token string">&quot;-&quot;</span> <span class="token operator">+</span> repository <span class="token operator">+</span> <span class="token string">&quot;-&quot;</span> <span class="token operator">+</span> commitBranch <span class="token operator">+</span> <span class="token string">&quot;-&quot;</span> <span class="token operator">+</span> <span class="token function">generateRandomString</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;.md&quot;</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="微信模板消息对接" tabindex="-1"><a class="header-anchor" href="#微信模板消息对接"><span>微信模板消息对接</span></a></h2><h3 id="流程分析-2" tabindex="-1"><a class="header-anchor" href="#流程分析-2"><span>流程分析</span></a></h3><p>本节的任务就是对接微信Api发送模板消息，该节的流程如下： <img src="`+y+`" alt="img_8.png"></p><h3 id="代码实现-2" tabindex="-1"><a class="header-anchor" href="#代码实现-2"><span>代码实现</span></a></h3><p>代码中所需要的微信公众号appid、模板消息id都可以在微信公众平台获取。微信公众平台：https://mp.weixin.qq.com/debug/cgi-bin/sandbox?t=sandbox/login</p><p>首先对接微信公众号测试平台，需要得到<code>access_token</code>，是后面调用接口的唯一凭证；这里作者提供了一个工具类用来获得<code>access_token</code></p><blockquote><p>Access Token是公众号调用微信平台API时必须的全局唯一凭证，有效期为2小时，需定期刷新。</p></blockquote><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WXAccessTokenUtils</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">APPID</span> <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">SECRET</span> <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">GRANT_TYPE</span> <span class="token operator">=</span> <span class="token string">&quot;client_credential&quot;</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">URL_TEMPLATE</span> <span class="token operator">=</span> <span class="token string">&quot;https://api.weixin.qq.com/cgi-bin/token?grant_type=%s&amp;appid=%s&amp;secret=%s&quot;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getAccessToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">try</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token class-name">String</span> urlString <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token constant">URL_TEMPLATE</span><span class="token punctuation">,</span> <span class="token constant">GRANT_TYPE</span><span class="token punctuation">,</span> <span class="token constant">APPID</span><span class="token punctuation">,</span> <span class="token constant">SECRET</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token class-name">URL</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>urlString<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token class-name">HttpURLConnection</span> connection <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HttpURLConnection</span><span class="token punctuation">)</span> url<span class="token punctuation">.</span><span class="token function">openConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            connection<span class="token punctuation">.</span><span class="token function">setRequestMethod</span><span class="token punctuation">(</span><span class="token string">&quot;GET&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">            <span class="token keyword">int</span> responseCode <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">getResponseCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Response Code:&quot;</span><span class="token operator">+</span>responseCode<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">            <span class="token keyword">if</span><span class="token punctuation">(</span>responseCode <span class="token operator">==</span> <span class="token class-name">HttpURLConnection</span><span class="token punctuation">.</span><span class="token constant">HTTP_OK</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token class-name">BufferedReader</span> in <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span>connection<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token class-name">String</span> inputLine<span class="token punctuation">;</span></span>
<span class="line">                <span class="token class-name">StringBuilder</span> response <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>inputLine <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                    response<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>inputLine<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">                in<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Response:&quot;</span><span class="token operator">+</span>response<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">                <span class="token class-name">Token</span> token <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token class-name">Token</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">                <span class="token keyword">return</span> token<span class="token punctuation">.</span><span class="token function">getAccess_token</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;GET request failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Token</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">private</span> <span class="token class-name">String</span> access_token<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">private</span> <span class="token class-name">Integer</span> expires_in<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getAccess_token</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> access_token<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAccess_token</span><span class="token punctuation">(</span><span class="token class-name">String</span> access_token<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span>access_token <span class="token operator">=</span> access_token<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">getExpires_in</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> expires_in<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setExpires_in</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> expires_in<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span>expires_in <span class="token operator">=</span> expires_in<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后创建了实体Message，用于承接模板消息，其中每一个param都需要对应模板消息中的DATA数据</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Message</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> touser <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> template_id <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">String</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        data<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">7092338402387318563L</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">{</span></span>
<span class="line">                <span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;value&quot;</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> setter and getter</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>发送模板消息的代码为：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * 微信公众号消息通知</span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">logUrl</span></span>
<span class="line"> */</span></span>
<span class="line"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">pushMessage</span><span class="token punctuation">(</span><span class="token class-name">String</span> logUrl<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">String</span> accessToken <span class="token operator">=</span> <span class="token class-name">WXAccessTokenUtils</span><span class="token punctuation">.</span><span class="token function">getAccessToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>accessToken<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token class-name">String</span> repo <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">&quot;REPOSITORY&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">int</span> idx <span class="token operator">=</span> repo<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token char">&#39;/&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">String</span> repository <span class="token operator">=</span> <span class="token punctuation">(</span>idx <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> idx <span class="token operator">&lt;</span> repo<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token operator">?</span> repo<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>idx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token operator">:</span> repo<span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">Message</span> message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    message<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;project&quot;</span><span class="token punctuation">,</span>repository<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    message<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;author&quot;</span><span class="token punctuation">,</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">&quot;COMMIT_AUTHOR&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    message<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;branch&quot;</span><span class="token punctuation">,</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">&quot;COMMIT_BRANCH&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    message<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;review&quot;</span><span class="token punctuation">,</span>logUrl<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    message<span class="token punctuation">.</span><span class="token function">setUrl</span><span class="token punctuation">(</span>logUrl<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;https://api.weixin.qq.com/cgi-bin/message/template/send?access_token=%s&quot;</span><span class="token punctuation">,</span>accessToken<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token function">sendPostRequest</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * 发送POST请求</span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">urlString</span></span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">jsonBody</span></span>
<span class="line"> */</span></span>
<span class="line"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">sendPostRequest</span><span class="token punctuation">(</span><span class="token class-name">String</span> urlString<span class="token punctuation">,</span> <span class="token class-name">String</span> jsonBody<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">URL</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>urlString<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">HttpURLConnection</span> conn <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HttpURLConnection</span><span class="token punctuation">)</span> url<span class="token punctuation">.</span><span class="token function">openConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        conn<span class="token punctuation">.</span><span class="token function">setRequestMethod</span><span class="token punctuation">(</span><span class="token string">&quot;POST&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        conn<span class="token punctuation">.</span><span class="token function">setRequestProperty</span><span class="token punctuation">(</span><span class="token string">&quot;Content-Type&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;application/json; utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        conn<span class="token punctuation">.</span><span class="token function">setRequestProperty</span><span class="token punctuation">(</span><span class="token string">&quot;Accept&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;application/json&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        conn<span class="token punctuation">.</span><span class="token function">setDoOutput</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">OutputStream</span> os <span class="token operator">=</span> conn<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> input <span class="token operator">=</span> jsonBody<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            os<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> input<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">Scanner</span> scanner <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scanner</span><span class="token punctuation">(</span>conn<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token class-name">String</span> response <span class="token operator">=</span> scanner<span class="token punctuation">.</span><span class="token function">useDelimiter</span><span class="token punctuation">(</span><span class="token string">&quot;\\\\A&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>优化</strong>：最终SDK是要给其它工程使用的，微信公众号appid、模板消息id、github仓库地址等参数，最终是需要从外界传入的，初步设想可以从环境变量中读取，将各个参数放置在<code>Github</code>的<code>Repository secret</code>中，在<code>workflow</code>文件中设置为环境变量，从而实现透传。</p><h2 id="代码工程结构重构" tabindex="-1"><a class="header-anchor" href="#代码工程结构重构"><span>代码工程结构重构</span></a></h2><p>结合开发过程中遇到的问题，我们需要重构工程，一是让功能结构更加合理，后续增加优化功能方便。二是让数据能由调用 SDK者传入；数据传入的方式就是在仓库中配置Action Secret，之后在工作流文件中读取即可；</p><h3 id="代码实现-3" tabindex="-1"><a class="header-anchor" href="#代码实现-3"><span>代码实现</span></a></h3><h4 id="_1-环境配置" tabindex="-1"><a class="header-anchor" href="#_1-环境配置"><span>1. 环境配置</span></a></h4><p>需要传入的数据可以定义在<code>Github</code>的<code>Repository secret</code>中，在<code>workflow</code>文件中设置为环境变量，还有一些根据每次提交获取的信息，如仓库名、提交分支名、提交者、提交信息等，则通过github action上下文以及git log命令获取，那么修改后的工作流文件为：</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Copy openai<span class="token punctuation">-</span>code<span class="token punctuation">-</span>review<span class="token punctuation">-</span>sdk JAR</span>
<span class="line">  <span class="token key atrule">run</span><span class="token punctuation">:</span> mvn dependency<span class="token punctuation">:</span>copy <span class="token punctuation">-</span>Dartifact=orbiszx.project<span class="token punctuation">:</span>openai<span class="token punctuation">-</span>code<span class="token punctuation">-</span>review<span class="token punctuation">-</span>sdk<span class="token punctuation">:</span>1.0 <span class="token punctuation">-</span>DoutputDirectory=./libs</span>
<span class="line"></span>
<span class="line"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Get repository name</span>
<span class="line">  <span class="token key atrule">id</span><span class="token punctuation">:</span> repo<span class="token punctuation">-</span>name</span>
<span class="line">  <span class="token key atrule">run</span><span class="token punctuation">:</span> echo &quot;REPO_NAME=$<span class="token punctuation">{</span>GITHUB_REPOSITORY<span class="token comment">##*/}&quot; &gt;&gt; $GITHUB_ENV</span></span>
<span class="line"></span>
<span class="line"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Get branch name</span>
<span class="line">  <span class="token key atrule">id</span><span class="token punctuation">:</span> branch<span class="token punctuation">-</span>name</span>
<span class="line">  <span class="token key atrule">run</span><span class="token punctuation">:</span> echo &quot;BRANCH_NAME=$<span class="token punctuation">{</span>GITHUB_REF<span class="token comment">#refs/heads/}&quot; &gt;&gt; $GITHUB_ENV</span></span>
<span class="line"></span>
<span class="line"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Get commit author</span>
<span class="line">  <span class="token key atrule">id</span><span class="token punctuation">:</span> commit<span class="token punctuation">-</span>author</span>
<span class="line">  <span class="token key atrule">run</span><span class="token punctuation">:</span> echo &quot;COMMIT_AUTHOR=$(git log <span class="token punctuation">-</span>1 <span class="token punctuation">-</span><span class="token punctuation">-</span>pretty=format<span class="token punctuation">:</span>&#39;%an &lt;%ae<span class="token punctuation">&gt;</span>&#39;)&quot; <span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span> $GITHUB_ENV</span>
<span class="line"></span>
<span class="line"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Get commit message</span>
<span class="line">  <span class="token key atrule">id</span><span class="token punctuation">:</span> commit<span class="token punctuation">-</span>message</span>
<span class="line">  <span class="token key atrule">run</span><span class="token punctuation">:</span> echo &quot;COMMIT_MESSAGE=$(git log <span class="token punctuation">-</span>1 <span class="token punctuation">-</span><span class="token punctuation">-</span>pretty=format<span class="token punctuation">:</span>&#39;%s&#39;)&quot; <span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span> $GITHUB_ENV</span>
<span class="line"></span>
<span class="line"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Print repository<span class="token punctuation">,</span> branch name<span class="token punctuation">,</span> commit author<span class="token punctuation">,</span> and commit message</span>
<span class="line">  <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="line">    echo &quot;Repository name is \${{ env.REPO_NAME }}&quot;</span>
<span class="line">    echo &quot;Branch name is \${{ env.BRANCH_NAME }}&quot;</span>
<span class="line">    echo &quot;Commit author is \${{ env.COMMIT_AUTHOR }}&quot;</span>
<span class="line">    echo &quot;Commit message is \${{ env.COMMIT_MESSAGE }}&quot; </span></span>
<span class="line"></span>
<span class="line"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Run Code Review</span>
<span class="line">  <span class="token key atrule">env</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token comment"># Github 配置；GITHUB_REVIEW_LOG_URI「https://github.com/orbisz/openai-code-review-log」、GITHUB_TOKEN「https://github.com/settings/tokens」</span></span>
<span class="line">    <span class="token key atrule">GITHUB_REVIEW_LOG_URI</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.CODE_REVIEW_LOG_URI <span class="token punctuation">}</span><span class="token punctuation">}</span></span>
<span class="line">    <span class="token key atrule">GITHUB_TOKEN</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.CODE_TOKEN <span class="token punctuation">}</span><span class="token punctuation">}</span></span>
<span class="line">    <span class="token key atrule">COMMIT_PROJECT</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> env.REPO_NAME <span class="token punctuation">}</span><span class="token punctuation">}</span></span>
<span class="line">    <span class="token key atrule">COMMIT_BRANCH</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> env.BRANCH_NAME <span class="token punctuation">}</span><span class="token punctuation">}</span></span>
<span class="line">    <span class="token key atrule">COMMIT_AUTHOR</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> env.COMMIT_AUTHOR <span class="token punctuation">}</span><span class="token punctuation">}</span></span>
<span class="line">    <span class="token key atrule">COMMIT_MESSAGE</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> env.COMMIT_MESSAGE <span class="token punctuation">}</span><span class="token punctuation">}</span></span>
<span class="line">    <span class="token comment"># 微信配置 「https://mp.weixin.qq.com/debug/cgi-bin/sandboxinfo?action=showinfo&amp;t=sandbox/index」</span></span>
<span class="line">    <span class="token key atrule">WEIXIN_APPID</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.WEIXIN_APPID <span class="token punctuation">}</span><span class="token punctuation">}</span></span>
<span class="line">    <span class="token key atrule">WEIXIN_SECRET</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.WEIXIN_SECRET <span class="token punctuation">}</span><span class="token punctuation">}</span></span>
<span class="line">    <span class="token key atrule">WEIXIN_TOUSER</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.WEIXIN_TOUSER <span class="token punctuation">}</span><span class="token punctuation">}</span></span>
<span class="line">    <span class="token key atrule">WEIXIN_TEMPLATE_ID</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.WEIXIN_TEMPLATE_ID <span class="token punctuation">}</span><span class="token punctuation">}</span></span>
<span class="line">    <span class="token comment"># OpenAi - ChatGLM 配置「https://open.bigmodel.cn/api/paas/v4/chat/completions」、「https://open.bigmodel.cn/usercenter/apikeys」</span></span>
<span class="line">    <span class="token key atrule">CHATGLM_APIHOST</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.CHATGLM_APIHOST <span class="token punctuation">}</span><span class="token punctuation">}</span></span>
<span class="line">    <span class="token key atrule">CHATGLM_APIKEYSECRET</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.CHATGLM_APIKEYSECRET <span class="token punctuation">}</span><span class="token punctuation">}</span></span>
<span class="line">          </span>
<span class="line">  <span class="token key atrule">run</span><span class="token punctuation">:</span> java <span class="token punctuation">-</span>jar ./libs/openai<span class="token punctuation">-</span>code<span class="token punctuation">-</span>review<span class="token punctuation">-</span>sdk<span class="token punctuation">-</span>1.0.jar</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-基础设施层" tabindex="-1"><a class="header-anchor" href="#_2-基础设施层"><span>2. 基础设施层</span></a></h4><p>该层主要承接了以下内容：</p><ul><li>1、git相关操作</li></ul><p>获取代码差异：这里放弃了之前使用git diff HEAD HEAD~1来获取代码差异的方式，而是通过先获取当前提交的commit-id即哈希值，然后该哈希值来获取代码差异；</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line">* 获取diffCode</span>
<span class="line">*</span>
<span class="line">* <span class="token keyword">@return</span> diffCode 代码差异</span>
<span class="line">* <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">Exception</span></span></span>
<span class="line">*/</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">diff</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token comment">// 1.git log: 得到git上一次提交的hash, 使用git diff HEAD HEAD~1 HEAD的方式有时不可靠, %H指的是提交完整Hash值</span></span>
<span class="line"><span class="token class-name">ProcessBuilder</span> logProcessBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProcessBuilder</span><span class="token punctuation">(</span><span class="token string">&quot;git&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;log&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--pretty=format:%H&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">logProcessBuilder<span class="token punctuation">.</span><span class="token function">directory</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token class-name">Process</span> logProcess <span class="token operator">=</span> logProcessBuilder<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token class-name">BufferedReader</span> logReader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span>logProcess<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token class-name">String</span> latestCommitLogHash <span class="token operator">=</span> logReader<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 每次提交都会生成一个hash值, 用来标识这次提交</span></span>
<span class="line">logReader<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">logProcess<span class="token punctuation">.</span><span class="token function">waitFor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 2.git diff: 获取代码diff</span></span>
<span class="line"><span class="token class-name">ProcessBuilder</span> diffProcessBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProcessBuilder</span><span class="token punctuation">(</span><span class="token string">&quot;git&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;diff&quot;</span><span class="token punctuation">,</span> latestCommitLogHash <span class="token operator">+</span> <span class="token string">&quot;^&quot;</span><span class="token punctuation">,</span> latestCommitLogHash<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">diffProcessBuilder<span class="token punctuation">.</span><span class="token function">directory</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token class-name">Process</span> diffProcess <span class="token operator">=</span> diffProcessBuilder<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token class-name">BufferedReader</span> diffReader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span>diffProcess<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token class-name">StringBuilder</span> diffCode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token class-name">String</span> line<span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>line <span class="token operator">=</span> diffReader<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">diffCode<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;\\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line">diffReader<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 3.等待git diff执行完成</span></span>
<span class="line"><span class="token keyword">int</span> waitCode <span class="token operator">=</span> diffProcess<span class="token punctuation">.</span><span class="token function">waitFor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">if</span> <span class="token punctuation">(</span>waitCode <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;failed to execute git diff and get code diff, waitCode:{}&quot;</span><span class="token punctuation">,</span> waitCode<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 4.返回diffCode</span></span>
<span class="line"><span class="token keyword">return</span> diffCode<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里有一个git命令</p><div class="language-git line-numbers-mode" data-highlighter="prismjs" data-ext="git" data-title="git"><pre><code><span class="line">git log -1 --pretty=format:%H</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>这个命令是Git版本控制系统中用来获取最近一次提交的哈希值的命令。</p><ul><li>git log: 这是Git命令行工具中的一个基本命令，用于显示提交历史记录。</li><li>-1: 这是一个参数，用于指定要显示的提交历史记录的条目数量。在这里，-1 意味着只显示最近的一次提交。</li><li>--pretty=format:: 这是一个选项，用于控制提交信息的格式。format: 后面跟着的是一个格式化字符串。</li><li>%H: 这是一个格式化占位符，表示提交的哈希值。</li></ul><p>执行这个命令后，将得到一个唯一的字符串，这个字符串表示Git仓库中最近一次提交的表示。</p><p>第二个命令</p><div class="language-giut line-numbers-mode" data-highlighter="prismjs" data-ext="giut" data-title="giut"><pre><code><span class="line">git diff e4759c3dfb2f3fd299d9b31a9e0a605f0b1b6d95^ e4759c3dfb2f3fd299d9b31a9e0a605f0b1b6d95 </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>这个命令是用来比较两个提交之间的差异的Git命令。</p><ul><li>git diff: 这是Git的一个命令，用于显示两个或多个提交、分支或文件之间的差异。</li><li>e4759c3dfb2f3fd299d9b31a9e0a605f0b1b6d95: 这是第一个提交的哈希值，表示你想要查看其差异的提交。</li><li>^: 在Git中，^ 符号用于引用当前分支的最近一次提交。如果前面有数字，它会引用该分支的第N个最近提交。在这个命令中，^ 指的是最新提交。</li><li>e4759c3dfb2f3fd299d9b31a9e0a605f0b1b6d95: 这是第二个提交的哈希值，也是你想要查看其差异的提交。</li></ul><p>提交评审日志到日志仓库：这里需要返回日志URI给后续发送模板消息；</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * 提交日志并推送到远程仓库</span>
<span class="line"> *</span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">reviewLog</span> 评审日志</span>
<span class="line"> * <span class="token keyword">@return</span> logURL 评审结果路径</span>
<span class="line"> * @Expection GitAPIException</span>
<span class="line"> */</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">commitAndPush</span><span class="token punctuation">(</span><span class="token class-name">String</span> reviewLog<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 1.克隆日志仓库</span></span>
<span class="line">    <span class="token class-name">Git</span> git <span class="token operator">=</span> <span class="token class-name">Git</span><span class="token punctuation">.</span><span class="token function">cloneRepository</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">setURI</span><span class="token punctuation">(</span>githubCommitLogUri<span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">setDirectory</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">&quot;repo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">setCredentialsProvider</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UsernamePasswordCredentialsProvider</span><span class="token punctuation">(</span>githubToken<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 2.创建日志文件夹</span></span>
<span class="line">    <span class="token class-name">String</span> dateFolderName <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">&quot;yyyy-mm-dd&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">File</span> dateFolder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">&quot;repo/&quot;</span> <span class="token operator">+</span> dateFolderName<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dateFolder<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 如果不存在则创建</span></span>
<span class="line">        dateFolder<span class="token punctuation">.</span><span class="token function">mkdirs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 3.创建日志文件&amp;写入日志</span></span>
<span class="line">    <span class="token class-name">String</span> fileName <span class="token operator">=</span> project <span class="token operator">+</span> <span class="token string">&quot;-&quot;</span> <span class="token operator">+</span> branch <span class="token operator">+</span> <span class="token string">&quot;-&quot;</span> <span class="token operator">+</span> author <span class="token operator">+</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;-&quot;</span> <span class="token operator">+</span> <span class="token class-name">RandomUtil</span><span class="token punctuation">.</span><span class="token function">randomString</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;.md&quot;</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">File</span> file <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>dateFolder<span class="token punctuation">,</span> fileName<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">FileWriter</span> writer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileWriter</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        writer<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>reviewLog<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 4.将文件添加到暂存区并提交</span></span>
<span class="line">    git<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addFilepattern</span><span class="token punctuation">(</span>dateFolderName <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> fileName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    git<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setMessage</span><span class="token punctuation">(</span><span class="token string">&quot;Add new file via Github Actions&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    git<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setCredentialsProvider</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UsernamePasswordCredentialsProvider</span><span class="token punctuation">(</span>githubToken<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;openai-code-review push and commit done!, fileName:{}&quot;</span><span class="token punctuation">,</span> fileName<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 5.返回日志路径方便后续模板消息使用</span></span>
<span class="line">    <span class="token keyword">return</span> githubCommitLogUri <span class="token operator">+</span> <span class="token string">&quot;/blob/main/&quot;</span> <span class="token operator">+</span> dateFolderName <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> fileName<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>2、AI代码评审</li></ul><p>接口定义，后面需要对接其它大模型，只需要新建一个类实现该接口即可（扩展开放），而不需要修改代码（修改关闭），满足开闭原则；</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * @Author: Lz</span>
<span class="line"> * Date: 2025/3/9 22:50</span>
<span class="line"> * Module function: openai接口, 定义规范方法, 可以接入不同的大模型</span>
<span class="line"> */</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IOpenAi</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token class-name">ChatCompletionSyncResponseDTO</span> <span class="token function">completion</span><span class="token punctuation">(</span><span class="token class-name">ChatCompletionRequestDTO</span> requestDTO<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>接口实现</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * openai实例-ChatGlm</span>
<span class="line"> *</span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">requestDTO</span></span>
<span class="line"> * <span class="token keyword">@return</span></span>
<span class="line"> * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">Exception</span></span></span>
<span class="line"> */</span></span>
<span class="line"><span class="token annotation punctuation">@Override</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">ChatCompletionSyncResponseDTO</span> <span class="token function">completion</span><span class="token punctuation">(</span><span class="token class-name">ChatCompletionRequestDTO</span> requestDTO<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">String</span> token <span class="token operator">=</span> <span class="token class-name">BearerTokenUtils</span><span class="token punctuation">.</span><span class="token function">getToken</span><span class="token punctuation">(</span>apiSecretKey<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 1.创建HTTP连接对象</span></span>
<span class="line">    <span class="token class-name">URL</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>apiHost<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">HttpURLConnection</span> connection <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HttpURLConnection</span><span class="token punctuation">)</span> url<span class="token punctuation">.</span><span class="token function">openConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    connection<span class="token punctuation">.</span><span class="token function">setRequestMethod</span><span class="token punctuation">(</span><span class="token string">&quot;POST&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    connection<span class="token punctuation">.</span><span class="token function">setRequestProperty</span><span class="token punctuation">(</span><span class="token string">&quot;Authorization&quot;</span><span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    connection<span class="token punctuation">.</span><span class="token function">setRequestProperty</span><span class="token punctuation">(</span><span class="token string">&quot;Content-type&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;application/json; utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    connection<span class="token punctuation">.</span><span class="token function">setRequestProperty</span><span class="token punctuation">(</span><span class="token string">&quot;Accept&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;application/json&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    connection<span class="token punctuation">.</span><span class="token function">setRequestProperty</span><span class="token punctuation">(</span><span class="token string">&quot;User-Agent&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Mozilla/4.0 (compatible; MSIE 5.0; Windows NT; DigExt)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    connection<span class="token punctuation">.</span><span class="token function">setDoOutput</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 2.读取响应数据</span></span>
<span class="line">    <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">OutputStream</span> os <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> input <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>requestDTO<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        os<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> input<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 3.处理响应结果</span></span>
<span class="line">    <span class="token class-name">BufferedReader</span> reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span>connection<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">StringBuilder</span> content <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">String</span> line<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>line <span class="token operator">=</span> reader<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        content<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;\\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    reader<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 4.返回响应结果</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>content<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ChatCompletionSyncResponseDTO</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>3、微信公众号对接</li></ul><p>发送模板消息：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * 发送微信模板消息</span>
<span class="line"> *</span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">logUrl</span> 日志评审日子, 不是发送微信模板消息的URL！！！</span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">data</span> 模板消息数据</span>
<span class="line"> * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">Exception</span></span></span>
<span class="line"> */</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendTemplateMessage</span><span class="token punctuation">(</span><span class="token class-name">String</span> logUrl<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> data<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 1.获取access_token</span></span>
<span class="line">    <span class="token class-name">String</span> accessToken <span class="token operator">=</span> <span class="token class-name">WXAccessTokenUtils</span><span class="token punctuation">.</span><span class="token function">getAccessToken</span><span class="token punctuation">(</span>appId<span class="token punctuation">,</span> appSecret<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">URL</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span><span class="token string">&quot;https://api.weixin.qq.com/cgi-bin/message/template/send?access_token=&quot;</span> <span class="token operator">+</span> accessToken<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">HttpURLConnection</span> connection <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HttpURLConnection</span><span class="token punctuation">)</span> url<span class="token punctuation">.</span><span class="token function">openConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    connection<span class="token punctuation">.</span><span class="token function">setRequestMethod</span><span class="token punctuation">(</span><span class="token string">&quot;POST&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">;</span></span>
<span class="line">    connection<span class="token punctuation">.</span><span class="token function">setRequestProperty</span><span class="token punctuation">(</span><span class="token string">&quot;Content-Type&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;application/json; utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    connection<span class="token punctuation">.</span><span class="token function">setRequestProperty</span><span class="token punctuation">(</span><span class="token string">&quot;Accept&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;application/json&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    connection<span class="token punctuation">.</span><span class="token function">setDoOutput</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 2.创建模板消息对象</span></span>
<span class="line">    <span class="token class-name">TemplateMessageDTO</span> templateMessageDTO <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TemplateMessageDTO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    templateMessageDTO<span class="token punctuation">.</span><span class="token function">setUrl</span><span class="token punctuation">(</span>logUrl<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    templateMessageDTO<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 3.发送模板消息, 即将消息以字节形式写入输入流, 然后发送到服务器(微信)</span></span>
<span class="line">    <span class="token comment">// 这里使用try-with-resources语法, 确保流关闭</span></span>
<span class="line">    <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">OutputStream</span> os <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> input <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>templateMessageDTO<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        os<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> input<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 4.响应结果解析, 即通过Scanner从输入流中读取数据</span></span>
<span class="line">    <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">Scanner</span> scanner <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scanner</span><span class="token punctuation">(</span>connection<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">String</span> response <span class="token operator">=</span> scanner<span class="token punctuation">.</span><span class="token function">useDelimiter</span><span class="token punctuation">(</span><span class="token string">&quot;\\\\A&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 确保读出所有响应数据</span></span>
<span class="line">        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;openai-code-review weixin TemplateMessage response:{}&quot;</span><span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-领域层" tabindex="-1"><a class="header-anchor" href="#_3-领域层"><span>3. 领域层</span></a></h4><p>本层使用了模板设计模式，将代码评审的过程拆分成多个步骤，在抽象类中定义了代码评审流程的骨架，而具体的功能由其子类实现；相比较MVC中Service层一直都是万年不变的接口 + 实现类，抽象类的优势是什么：</p><ol><li>固化流程：使用了模板设计模式，在抽象类中定义了代码评审的固定流程，而子类就只需要关注具体步骤的实现，而不需要关注整体流程；</li><li>复用公共逻辑：如依赖注入、异常处理、日志处理等等；</li><li>扩展性高：后续如果需要实现其它git平台的代码评审，直接创建子类实现抽象类中的方法即可，而不需要关注具体流程，同时这也符合开闭原则；</li><li>但是并不是所有场景都适合，简单、规模较小或对扩展性要求不高的场景，就可以考虑直接使用接口+实现类的模式，避免不必要的分层；</li></ol><p>那么具体的代码实现为：</p><ul><li>接口</li></ul><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * @Author: Lz</span>
<span class="line"> * Date: 2025/3/9 16:36</span>
<span class="line"> * Module function: 评审服务接口</span>
<span class="line"> */</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IOpenAiCodeReviewService</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">void</span> <span class="token function">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span> </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>抽象类</li></ul><p>其中的exec就是一个模板方法，定义了代码评审流程的骨架，并且在这里统一做了异常处理；</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * @Author: Lz</span>
<span class="line"> * Date: 2025/3/9 16:36</span>
<span class="line"> * Module function: 代码评审服务抽象类-用于定义模板, 就是流程, 具体实现由子类去做</span>
<span class="line"> */</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractOpenAiCodeReviewService</span> <span class="token keyword">implements</span> <span class="token class-name">IOpenAiCodeReviewService</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Logger</span><span class="token punctuation">)</span><span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">AbstractOpenAiCodeReviewService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">GitCommand</span> gitCommand<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">IOpenAi</span> openAi<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">WeiXin</span> weiXin<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">AbstractOpenAiCodeReviewService</span><span class="token punctuation">(</span><span class="token class-name">GitCommand</span> gitCommand<span class="token punctuation">,</span> <span class="token class-name">IOpenAi</span> openAi<span class="token punctuation">,</span> <span class="token class-name">WeiXin</span> weiXin<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>gitCommand <span class="token operator">=</span> gitCommand<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>openAi <span class="token operator">=</span> openAi<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>weiXin <span class="token operator">=</span> weiXin<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line">     * 定义执行流程</span>
<span class="line">     */</span></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// 1.获得提交代码: 返回diff_code</span></span>
<span class="line">            <span class="token class-name">String</span> diffCode <span class="token operator">=</span> <span class="token function">getDiffCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token comment">// 2.代码评审记录: 返回评审日志</span></span>
<span class="line">            <span class="token class-name">String</span> log <span class="token operator">=</span> <span class="token function">codeReview</span><span class="token punctuation">(</span>diffCode<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token comment">// 3.评审记录保存: 返回评审日志URL</span></span>
<span class="line">            <span class="token class-name">String</span> logUrl <span class="token operator">=</span> <span class="token function">recordCodeReview</span><span class="token punctuation">(</span>log<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token comment">// 4.发送消息通知: 模板消息, 评审日志</span></span>
<span class="line">            <span class="token function">pushMessage</span><span class="token punctuation">(</span>logUrl<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;openai-code-review error: &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token class-name">String</span> <span class="token function">getDiffCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token class-name">String</span> <span class="token function">codeReview</span><span class="token punctuation">(</span><span class="token class-name">String</span> diffCode<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token class-name">String</span> <span class="token function">recordCodeReview</span><span class="token punctuation">(</span><span class="token class-name">String</span> log<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">pushMessage</span><span class="token punctuation">(</span><span class="token class-name">String</span> logUrl<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>实现类</li></ul><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OpenAiCodeReviewService</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractOpenAiCodeReviewService</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">OpenAiCodeReviewService</span><span class="token punctuation">(</span><span class="token class-name">GitCommand</span> gitCommand<span class="token punctuation">,</span> <span class="token class-name">IOpenAi</span> openAi<span class="token punctuation">,</span> <span class="token class-name">WeiXin</span> weiXin<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">super</span><span class="token punctuation">(</span>gitCommand<span class="token punctuation">,</span> openAi<span class="token punctuation">,</span> weiXin<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line">     * 获取diffCode</span>
<span class="line">     *</span>
<span class="line">     * <span class="token keyword">@return</span> diffCode</span>
<span class="line">     * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">Exception</span></span></span>
<span class="line">     */</span></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">protected</span> <span class="token class-name">String</span> <span class="token function">getDiffCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> gitCommand<span class="token punctuation">.</span><span class="token function">diff</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line">     * 代码评审</span>
<span class="line">     *</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">diffCode</span></span>
<span class="line">     * <span class="token keyword">@return</span> 代码评审结果 log</span>
<span class="line">     * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">Exception</span></span></span>
<span class="line">     */</span></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">protected</span> <span class="token class-name">String</span> <span class="token function">codeReview</span><span class="token punctuation">(</span><span class="token class-name">String</span> diffCode<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 构造Request请求对象</span></span>
<span class="line">        <span class="token class-name">ChatCompletionRequestDTO</span> requestDTO <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChatCompletionRequestDTO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        requestDTO<span class="token punctuation">.</span><span class="token function">setModel</span><span class="token punctuation">(</span><span class="token class-name">Model</span><span class="token punctuation">.</span><span class="token constant">GLM_4_FLASH</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        requestDTO<span class="token punctuation">.</span><span class="token function">setMessages</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">7988151926241837899L</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">{</span></span>
<span class="line">                <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChatCompletionRequestDTO<span class="token punctuation">.</span>Prompt</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;你是一个高级编程架构师，精通各类场景方案、架构设计和编程语言请，请您根据git diff记录，对代码做出评审。代码如下:&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChatCompletionRequestDTO<span class="token punctuation">.</span>Prompt</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> diffCode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">ChatCompletionSyncResponseDTO</span> completion <span class="token operator">=</span> openAi<span class="token punctuation">.</span><span class="token function">completion</span><span class="token punctuation">(</span>requestDTO<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">ChatCompletionSyncResponseDTO<span class="token punctuation">.</span>Message</span> message <span class="token operator">=</span> completion<span class="token punctuation">.</span><span class="token function">getChoices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> message<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line">     * 代码评审日志写入</span>
<span class="line">     *</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">log</span></span>
<span class="line">     * <span class="token keyword">@return</span> logUrl</span>
<span class="line">     * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">Exception</span></span></span>
<span class="line">     */</span></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">protected</span> <span class="token class-name">String</span> <span class="token function">recordCodeReview</span><span class="token punctuation">(</span><span class="token class-name">String</span> log<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> gitCommand<span class="token punctuation">.</span><span class="token function">commitAndPush</span><span class="token punctuation">(</span>log<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line">     * 发送微信模板消息</span>
<span class="line">     *</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">logUrl</span></span>
<span class="line">     */</span></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">pushMessage</span><span class="token punctuation">(</span><span class="token class-name">String</span> logUrl<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 1.构造请求数据Data</span></span>
<span class="line">        <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">TemplateMessageDTO</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token class-name">TemplateMessageDTO<span class="token punctuation">.</span>TemplateKey</span><span class="token punctuation">.</span><span class="token constant">PROJECT_NAME</span><span class="token punctuation">,</span> gitCommand<span class="token punctuation">.</span><span class="token function">getProject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">TemplateMessageDTO</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token class-name">TemplateMessageDTO<span class="token punctuation">.</span>TemplateKey</span><span class="token punctuation">.</span><span class="token constant">BRANCH_NAME</span><span class="token punctuation">,</span> gitCommand<span class="token punctuation">.</span><span class="token function">getBranch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">TemplateMessageDTO</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token class-name">TemplateMessageDTO<span class="token punctuation">.</span>TemplateKey</span><span class="token punctuation">.</span><span class="token constant">COMMIT_AUTHOR</span><span class="token punctuation">,</span> gitCommand<span class="token punctuation">.</span><span class="token function">getAuthor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">TemplateMessageDTO</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token class-name">TemplateMessageDTO<span class="token punctuation">.</span>TemplateKey</span><span class="token punctuation">.</span><span class="token constant">COMMIT_MESSAGE</span><span class="token punctuation">,</span> gitCommand<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">// 2.调用服务</span></span>
<span class="line">        weiXin<span class="token punctuation">.</span><span class="token function">sendTemplateMessage</span><span class="token punctuation">(</span>logUrl<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-程序入口" tabindex="-1"><a class="header-anchor" href="#_4-程序入口"><span>4. 程序入口</span></a></h4><p>流程方法由此调用，所有的环境变量也都由此传入，代码如下：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OpenAiCodeReview</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">OpenAiCodeReview</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line">     * 程序入口</span>
<span class="line">     * </span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">args</span></span>
<span class="line">     */</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 1.GitCommand</span></span>
<span class="line">        <span class="token class-name">GitCommand</span> gitCommand <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GitCommand</span><span class="token punctuation">(</span></span>
<span class="line">                <span class="token function">getEnv</span><span class="token punctuation">(</span><span class="token string">&quot;GITHUB_REVIEW_LOG_URI&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token function">getEnv</span><span class="token punctuation">(</span><span class="token string">&quot;GITHUB_TOKEN&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token function">getEnv</span><span class="token punctuation">(</span><span class="token string">&quot;COMMIT_AUTHOR&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token function">getEnv</span><span class="token punctuation">(</span><span class="token string">&quot;COMMIT_PROJECT&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token function">getEnv</span><span class="token punctuation">(</span><span class="token string">&quot;COMMIT_BRANCH&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token function">getEnv</span><span class="token punctuation">(</span><span class="token string">&quot;COMMIT_MESSAGE&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">// 2.ChatGlm</span></span>
<span class="line">        <span class="token class-name">ChatGlm</span> chatGlm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChatGlm</span><span class="token punctuation">(</span></span>
<span class="line">                <span class="token function">getEnv</span><span class="token punctuation">(</span><span class="token string">&quot;CHATGLM_API_HOST&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token function">getEnv</span><span class="token punctuation">(</span><span class="token string">&quot;CHATGLM_API_SECRET_KEY&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">// 3.WeiXin</span></span>
<span class="line">        <span class="token class-name">WeiXin</span> weiXin <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeiXin</span><span class="token punctuation">(</span></span>
<span class="line">                <span class="token function">getEnv</span><span class="token punctuation">(</span><span class="token string">&quot;WEIXIN_APPID&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token function">getEnv</span><span class="token punctuation">(</span><span class="token string">&quot;WEIXIN_APP_SECRET&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token function">getEnv</span><span class="token punctuation">(</span><span class="token string">&quot;WEIXIN_TOUSER&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token function">getEnv</span><span class="token punctuation">(</span><span class="token string">&quot;WEIXIN_TEMPLATE_ID&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token class-name">OpenAiCodeReviewService</span> service <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OpenAiCodeReviewService</span><span class="token punctuation">(</span>gitCommand<span class="token punctuation">,</span> chatGlm<span class="token punctuation">,</span> weiXin<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        service<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;openai-code-review done!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line">     * 读取环境变量</span>
<span class="line">     *</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">key</span></span>
<span class="line">     * <span class="token keyword">@return</span></span>
<span class="line">     */</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getEnv</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">String</span> env <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getenv</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>env <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> env<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;key is null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">return</span> env<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>微信模板消息发送成功，点击模板消息跳转评审记录;</p><h2 id="发布部署使用" tabindex="-1"><a class="header-anchor" href="#发布部署使用"><span>发布部署使用</span></a></h2><p>本节的任务就是让别人可以使用我们开发的SDK，思路是将<code>jar</code>放在别人能下载的地方，然后在工作流文件中下载该jar包并执行，这里和作者一样选择放在日志仓库的release中； <img src="`+w+`" alt="img_9.png"></p><p>将Maven构建的过程改成下载Jar包，这里使用curl或者wget命令下载均可（但是我使用wget不知道为什么一直报错）；</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token comment"># 1、Maven构建</span></span>
<span class="line"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Build with Maven  <span class="token comment"># 编译构建Maven</span></span>
<span class="line">  <span class="token key atrule">run</span><span class="token punctuation">:</span> mvn clean install</span>
<span class="line"></span>
<span class="line"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Copy Openai<span class="token punctuation">-</span>Code<span class="token punctuation">-</span>Review<span class="token punctuation">-</span>SDK JAR  <span class="token comment"># 复制JAR包</span></span>
<span class="line">  <span class="token key atrule">run</span><span class="token punctuation">:</span> mvn dependency<span class="token punctuation">:</span>copy <span class="token punctuation">-</span>Dartifact=com.lz<span class="token punctuation">:</span>openai<span class="token punctuation">-</span>code<span class="token punctuation">-</span>review<span class="token punctuation">-</span>sdk<span class="token punctuation">:</span>1.0 <span class="token punctuation">-</span>DoutputDirectory=./libs</span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 2、Jar包下载</span></span>
<span class="line"><span class="token comment"># 创建libs目录</span></span>
<span class="line"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Create libs directory</span>
<span class="line">  <span class="token key atrule">run</span><span class="token punctuation">:</span> mkdir <span class="token punctuation">-</span>p ./libs</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 下载SDK-jar包, 注意下载仓库需要为public</span></span>
<span class="line"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Download openai<span class="token punctuation">-</span>code<span class="token punctuation">-</span>review<span class="token punctuation">-</span>sdk jar</span>
<span class="line">  <span class="token key atrule">run</span><span class="token punctuation">:</span> curl <span class="token punctuation">-</span>L <span class="token punctuation">-</span>o ./libs/openai<span class="token punctuation">-</span>code<span class="token punctuation">-</span>review<span class="token punctuation">-</span>sdk<span class="token punctuation">-</span>1.0.jar https<span class="token punctuation">:</span>//github.com/Deanccccc/openai<span class="token punctuation">-</span>code<span class="token punctuation">-</span>review<span class="token punctuation">-</span>log/releases/download/v1.0/openai<span class="token punctuation">-</span>code<span class="token punctuation">-</span>review<span class="token punctuation">-</span>sdk<span class="token punctuation">-</span>1.0.jar</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后测试可以实现同样的功能，在之后我们开发自己的项目过程中也可以引入该SDK；</p><p>用户提交代码时触发评审，调用基于RAG优化的大模型分析代码差异并生成评审建议，评审结果通过微信公众号推送，评审日志持久化至独立仓库。该系统通过自动化评审辅助人工评审，显著提高了评审的效率与准确性；</p><h2 id="功能优化" tabindex="-1"><a class="header-anchor" href="#功能优化"><span>功能优化</span></a></h2><ul><li>基于模板设计模式抽象代码评审流程，通过构建Github Action工作流，定义代码检出、AI评审、日志存储及消息触达的自动化链路；</li><li>对接DeepSeek API分析代码质量并提供评审建议，实现AI驱动的代码评审流程；</li><li>对接RAG知识库，用户上传的文本经过解析、拆分、打标以及向量化后存入向量数据库，通过相似性检索优化LLM提示词生成，有效提高DeepSeek模型评审的上下文感知能力与精准度；</li><li>对接微信公众号平台，将代码评审结果通过模板消息及时触达开发人员，提升反馈效率；</li><li>该代码评审工具服务上面的抽奖系统设计，显著提高工程代码质量与可靠性；</li></ul><h2 id="扩展与优化" tabindex="-1"><a class="header-anchor" href="#扩展与优化"><span>扩展与优化</span></a></h2><h3 id="企业级应用" tabindex="-1"><a class="header-anchor" href="#企业级应用"><span>企业级应用</span></a></h3><p>开源 LLMs + 领域知识库 + 私有化部署</p><ul><li>这里 LLMs 指多个大模型组合使用；大模型再强大也必须结合内部的知识库才能发挥作用；</li><li>私有化部署好处是打消各行各业对数据安全的担忧</li><li>最终的产品形态需要具体场景具体分析！</li></ul><p>扩展对接的大模型接口，甚至可以使用开源模型进行私有化部署.隔离外网访问，确保代码 CR 过程仅在内网环境下完成。</p><p>通知对接多个平台，例如飞书、钉钉等</p><p>优化提示词，增加提示词模板等等</p><p>统一环境配置参数的封装</p><p>让 LLM 通过文件代码分析当前代码涉及的知识点，用于后续知识库相似度匹配；对接知识库，使用国产文本相似度计算模型，并私有化部署公司内网，然后存储在向量数据库中。</p><blockquote><p>如果使用的模型（如 LLaMA 2）对中文 Prompt 支持较差，需要在设计 Prompt 时采用『输入英文』『输出中文』的方式</p></blockquote><p>大模型基座只包含互联网上的公开数据，对公司内部的框架知识和使用文档并不了解。有了知识库，通过三个过程找到相关度最高的内容：</p><ol><li>Text Embeddings（文本向量化）</li><li>Vector Stores（向量存储）</li><li>Similarity Search（相似性搜索）</li></ol>`,174)),s("ul",null,[s("li",null,[s("a",f,[n[0]||(n[0]=p("基于大模型 + 知识库的 Code Review 实践")),t(a)])]),s("li",null,[s("a",q,[n[1]||(n[1]=p("适用所有团队研发提效｜带你1分钟上手基于Claude Code的AI代码评审实践")),t(a)])])])])}const R=e(h,[["render",S]]),_=JSON.parse('{"path":"/blogs/Project/code-review/code-review.html","title":"AI 代码自动评审组件开发","lang":"en-US","frontmatter":{"title":"AI 代码自动评审组件开发","date":"2025/12/06","tags":["AI","组件开发","代码评审"],"categories":["后端开发"]},"headers":[{"level":2,"title":"业务功能设计","slug":"业务功能设计","link":"#业务功能设计","children":[]},{"level":2,"title":"项目背景知识","slug":"项目背景知识","link":"#项目背景知识","children":[{"level":3,"title":"1、CI&CD","slug":"_1、ci-cd","link":"#_1、ci-cd","children":[]},{"level":3,"title":"2、Github Action","slug":"_2、github-action","link":"#_2、github-action","children":[]}]},{"level":2,"title":"SDK工程搭建","slug":"sdk工程搭建","link":"#sdk工程搭建","children":[]},{"level":2,"title":"Maven构建与脚本执行","slug":"maven构建与脚本执行","link":"#maven构建与脚本执行","children":[]},{"level":2,"title":"大模型对接-ChatGlm","slug":"大模型对接-chatglm","link":"#大模型对接-chatglm","children":[{"level":3,"title":"流程分析","slug":"流程分析","link":"#流程分析","children":[]},{"level":3,"title":"代码实现","slug":"代码实现","link":"#代码实现","children":[]}]},{"level":2,"title":"评审日志处理","slug":"评审日志处理","link":"#评审日志处理","children":[{"level":3,"title":"流程分析","slug":"流程分析-1","link":"#流程分析-1","children":[]},{"level":3,"title":"代码实现","slug":"代码实现-1","link":"#代码实现-1","children":[]}]},{"level":2,"title":"微信模板消息对接","slug":"微信模板消息对接","link":"#微信模板消息对接","children":[{"level":3,"title":"流程分析","slug":"流程分析-2","link":"#流程分析-2","children":[]},{"level":3,"title":"代码实现","slug":"代码实现-2","link":"#代码实现-2","children":[]}]},{"level":2,"title":"代码工程结构重构","slug":"代码工程结构重构","link":"#代码工程结构重构","children":[{"level":3,"title":"代码实现","slug":"代码实现-3","link":"#代码实现-3","children":[]}]},{"level":2,"title":"发布部署使用","slug":"发布部署使用","link":"#发布部署使用","children":[]},{"level":2,"title":"功能优化","slug":"功能优化","link":"#功能优化","children":[]},{"level":2,"title":"扩展与优化","slug":"扩展与优化","link":"#扩展与优化","children":[{"level":3,"title":"企业级应用","slug":"企业级应用","link":"#企业级应用","children":[]}]}],"git":{"createdTime":1755092504000,"updatedTime":1766044535000,"contributors":[{"name":"orbisz","email":"zxy0613zxy@outlook.com","commits":2},{"name":"zxy","email":"zxy0613zxy@outlook.com","commits":1}]},"filePathRelative":"blogs/Project/code-review/code-review.md"}');export{R as comp,_ as data};
